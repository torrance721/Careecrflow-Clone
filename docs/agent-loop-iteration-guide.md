# Agent Loop 对抗生成迭代指南

## 核心理念

对抗生成的目标是通过不断提升用户"挑剔度"来发现系统问题并改进。**通过测试不是终点，而是提升难度的起点。**

## 信任度与挑剔度

| 信任度 | 挑剔度 | 用户行为特征 | 满足难度 |
|--------|--------|--------------|----------|
| 1-3 | 8-10 | 回答简短、怀疑系统、快速要求看结果 | 极难 |
| 4-6 | 5-7 | 正常交互、愿意尝试、有一定耐心 | 中等 |
| 7-10 | 1-4 | 详细回答、信任系统、愿意深入交流 | 容易 |

## 迭代流程

```
┌─────────────────────────────────────────────────────────┐
│                    迭代开始                              │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│  Step 1: 生成 Persona（根据当前信任度分布）              │
│  - 读取 currentTrustLevel 配置                          │
│  - 生成对应挑剔度的 Persona                             │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│  Step 2: 运行话题练习模拟                                │
│  - 使用真实 Agent（JobRecommendation, Feedback 等）     │
│  - 收集满意度、推荐率等指标                             │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│  Step 3: 评估结果                                        │
│  - 检查质量门控（满意度 ≥ 8, 推荐率 ≥ 80%）             │
│  - 收集改进建议                                         │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │   质量门控通过？       │
              └───────────────────────┘
                    │           │
                   是           否
                    │           │
                    ▼           ▼
    ┌───────────────────┐  ┌───────────────────┐
    │ 提升挑剔度        │  │ 应用改进          │
    │ - 降低信任度      │  │ - 分析失败原因    │
    │ - 步长递减        │  │ - 应用自动改进    │
    │ - 继续迭代        │  │ - 保持当前难度    │
    └───────────────────┘  └───────────────────┘
                    │           │
                    └─────┬─────┘
                          │
                          ▼
              ┌───────────────────────┐
              │   达到停止条件？       │
              │   - 信任度 ≤ 1        │
              │   - 连续失败 3 次     │
              │   - 达到最大迭代      │
              └───────────────────────┘
                    │           │
                   是           否
                    │           │
                    ▼           ▼
              ┌──────────┐  ┌──────────┐
              │ 输出报告 │  │ 继续迭代 │
              └──────────┘  └──────────┘
```

## 信任度调整规则

### 通过质量门控后
```
新信任度 = 当前信任度 - 调整步长
调整步长 = max(0.5, 当前步长 * 0.8)  // 步长递减，越难越慢
```

### 未通过质量门控后
```
保持当前信任度，应用改进后重试
连续失败 3 次后，信任度 +1（降低难度）
```

## 可自动改进的点（不改变结构）

以下改进可以通过调整 prompt 或参数实现，无需修改代码结构：

| 改进点 | 实现方式 | 触发条件 |
|--------|----------|----------|
| 引导语优化 | 调整开场问题的 prompt | 用户反馈"问题太笼统" |
| 累积上下文 | 在后续话题中携带前面收集的信息 | 用户反馈"推荐不连贯" |
| 追问深度 | 调整追问策略的 prompt | 用户反馈"问题重复" |
| 反馈详细度 | 调整反馈生成的 prompt | 用户反馈"反馈太笼统" |
| 推荐理由 | 调整推荐理由生成的 prompt | 用户反馈"理由不够具体" |

## 改进应用机制

每次迭代后，系统会：

1. **分析反馈关键词**
   - 提取用户 comments 中的关键问题
   - 匹配到对应的改进点

2. **更新配置文件**
   - 将改进应用到 `iteration-config.json`
   - 下次迭代自动使用新配置

3. **记录改进历史**
   - 保存每次改进的内容和效果
   - 用于回溯和分析

## 配置文件结构

```json
{
  "currentIteration": 1,
  "currentTrustLevel": 5,
  "trustLevelStep": 1,
  "consecutiveFailures": 0,
  "improvements": {
    "openingQuestion": {
      "enabled": true,
      "version": 1,
      "prompt": "直接给出具体、有针对性的问题，避免笼统的开场白"
    },
    "cumulativeContext": {
      "enabled": true,
      "version": 1,
      "carryForwardTopics": true
    },
    "followUpDepth": {
      "enabled": true,
      "version": 1,
      "maxSameQuestion": 2
    }
  },
  "history": []
}
```

## 停止条件

迭代在以下任一条件满足时停止：

1. **信任度达到极限**：信任度 ≤ 1 且仍然通过（系统已足够强大）
2. **连续失败**：在同一信任度连续失败 3 次且无法自动改进
3. **最大迭代**：达到预设的最大迭代次数（默认 20）
4. **人工干预**：需要修改代码结构的改进

## 输出报告

每次迭代结束后生成报告，包含：

- 当前信任度和挑剔度
- 质量门控结果
- 应用的改进
- 下一步建议
- 是否需要人工干预

## 使用方法

```bash
# 运行对抗生成循环
cd /home/ubuntu/UHWeb
npx tsx server/agents/agentLoop/runAdversarialLoop.ts

# 查看当前配置
cat data/iteration-config.json

# 查看迭代历史
ls -la data/adversarial-loop-results/
```
